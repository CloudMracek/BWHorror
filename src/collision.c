#include "collision.h"
#define PLAYER_SIZE 1

#pragma region collider
int collider_faces = 151;

SVECTOR collider_vertices[] = {
    {-500,0,-500},
    {-500,0,500},
    {500,0,-500},
    {500,0,500},
    {-1500,0,500},
    {-1500,0,-500},
    {-2500,0,500},
    {-2500,0,-500},
    {-3500,0,500},
    {-3500,0,-500},
    {-4500,0,500},
    {-4500,0,-500},
    {-5500,0,500},
    {-5500,0,-500},
    {-500,0,500},
    {-1500,0,500},
    {-500,0,5500},
    {-1500,0,5500},
    {-500,0,1500},
    {-500,0,2500},
    {-500,0,3500},
    {-500,0,4500},
    {-1500,0,1500},
    {-1500,0,2500},
    {-1500,0,3500},
    {-1500,0,4500},
    {1500,0,-500},
    {1500,0,500},
    {1500,0,3500},
    {1500,0,4500},
    {500,0,4500},
    {500,0,3500},
    {1500,0,3500},
    {500,0,3500},
    {1500,0,1500},
    {500,0,1500},
    {1500,0,2500},
    {500,0,2500},
    {-500,0,-1500},
    {-1500,0,-1500},
    {-500,0,-1500},
    {-1500,0,-1500},
    {-500,0,-2500},
    {-1500,0,-2500},
    {-500,0,-3500},
    {-1500,0,-3500},
    {-500,0,-4500},
    {-1500,0,-4500},
    {-500,0,-5500},
    {-1500,0,-5500},
    {-3500,0,-1500},
    {-3500,0,-2500},
    {-2500,0,-1500},
    {-2500,0,-2500},
    {-3500,0,-3500},
    {-2500,0,-3500},
    {500,0,-3500},
    {500,0,-4500},
    {1500,0,-3500},
    {1500,0,-4500},
    {500,0,-3500},
    {1500,0,-3500},
    {500,0,-1500},
    {1500,0,-1500},
    {500,0,-2500},
    {1500,0,-2500},
    {2500,0,-3500},
    {2500,0,-2500},
    {2500,0,-3500},
    {2500,0,-2500},
    {3500,0,-3500},
    {3500,0,-2500},
    {4500,0,-3500},
    {4500,0,-2500},
    {2500,0,-500},
    {3500,0,-500},
    {2500,0,-1500},
    {3500,0,-1500},
    {4500,0,3500},
    {4500,0,2500},
    {3500,0,3500},
    {2500,0,3500},
    {2500,0,2500},
    {3500,0,2500},
    {2500,0,500},
    {3500,0,500},
    {3500,0,1500},
    {2500,0,1500},
    {-2500,0,2500},
    {-3500,0,2500},
    {-2500,0,1500},
    {-3500,0,1500},
    {-2500,0,4500},
    {-3500,0,4500},
    {-3500,0,3500},
    {-2500,0,3500},
    {-3500,0,4500},
    {-3500,0,3500},
    {-5500,0,4500},
    {-5500,0,3500},
    {-4500,0,4500},
    {-4500,0,3500},
    {-5500,0,2500},
    {-4500,0,2500},
    {-6500,0,500},
    {-6500,0,-500},
    {-5500,0,-1500},
    {-6500,0,-1500},
    {-5500,0,1500},
    {-6500,0,1500},
    {-6500,0,500},
    {-6500,0,-500},
    {-6500,0,-1500},
    {-6500,0,1500},
    {-7500,0,500},
    {-7500,0,-500},
    {-7500,0,-1500},
    {-7500,0,1500},
    {-8500,0,500},
    {-8500,0,-500},
    {-8500,0,-1500},
    {-8500,0,1500},
    {-9500,0,500},
    {-9500,0,-500},
    {-9500,0,-1500},
    {-9500,0,1500},
    {-3500,0,-4500},
    {-3750,0,-3250},
    {-10500,0,500},
    {-10500,0,-500},
    {-10500,0,-1500},
    {-10500,0,1500},
    {-7500,0,-4500},
    {-8500,0,-4500},
    {-6500,0,-3500},
    {-6500,0,-4500},
    {-4500,0,-3500},
    {-5500,0,-3500},
    {-4500,0,-4500},
    {-5500,0,-4500},
    {-8500,0,-2500},
    {-8500,0,-3500},
    {-7500,0,-2500},
    {-7500,0,-3500},
    {-8500,0,-2500},
    {-8500,0,-3500},
    {-9500,0,-2500},
    {-9500,0,-3500},
    {-10500,0,-2500},
    {-10500,0,-3500},
    {-11500,0,-2500},
    {-11500,0,-3500},
    {-500,0,6500},
    {-1500,0,6500},
    {500,0,5500},
    {500,0,6500},
    {-2500,0,5500},
    {-2500,0,6500},
    {-500,0,7500},
    {-1500,0,7500},
    {500,0,7500},
    {-2500,0,7500},
    {-500,0,8500},
    {-1500,0,8500},
    {500,0,8500},
    {-2500,0,8500},
    {-500,0,8500},
    {-1500,0,8500},
    {500,0,8500},
    {-2500,0,8500},
    {-5500,0,6500},
    {-5500,0,7500},
    {-5500,0,5500},
    {-4500,0,5500},
    {-4500,0,6500},
    {-3500,0,6500},
    {-4500,0,7500},
    {-3500,0,7500},
    {-6500,0,6500},
    {-6500,0,7500},
    {-7500,0,6500},
    {-7500,0,7500},
    {-8500,0,6500},
    {-8500,0,7500},
    {-6500,0,4500},
    {-6500,0,3500},
    {-7500,0,4500},
    {-7500,0,3500},
    {-8500,0,4500},
    {-8250,0,3753},
    {-7500,0,5500},
    {-8500,0,5500},
    {-7246,0,4758},
    {-9500,0,6500},
    {-9500,0,5500},
    {-10500,0,6500},
    {-10500,0,5500},
    {-11500,0,6500},
    {-11500,0,5500},
    {-12500,0,6500},
    {-12500,0,5500},
    {-11500,0,1500},
    {-12500,0,1500},
    {-11500,0,500},
    {-12500,0,500},
    {-11500,0,-500},
    {-12500,0,-500},
    {-11500,0,4500},
    {-11500,0,3500},
    {-11500,0,2500},
    {-12500,0,2500},
    {-12500,0,3500},
    {-12500,0,4500},
    {-9500,0,4500},
    {-10500,0,4500},
    {-9500,0,3500},
    {-10500,0,3500},
    {-9500,0,2500},
    {-10500,0,2500},
    {-8500,0,3500},
    {-8500,0,2500},
    {4500,0,6500},
    {4500,0,7500},
    {1500,0,6500},
    {2500,0,6500},
    {3500,0,6500},
    {1500,0,7500},
    {2500,0,7500},
    {3500,0,7500},
    {3500,0,4500},
    {3500,0,5500},
    {2500,0,4500},
    {2500,0,5500},
    {-500,0,-6500},
    {-1500,0,-6500},
    {500,0,-5500},
    {500,0,-6500},
    {-2500,0,-5500},
    {-2500,0,-6500},
    {-3500,0,-5500},
    {-3500,0,-6500},
    {-4500,0,-5500},
    {-4500,0,-6500},
    {-500,0,-7500},
    {-1500,0,-7500},
    {500,0,-7500},
    {-2500,0,-7500},
    {-3500,0,-7500},
    {-4500,0,-7500},
    {-500,0,-8500},
    {-1500,0,-8500},
    {500,0,-8500},
    {-2500,0,-8500},
    {-3500,0,-8500},
    {-4500,0,-8500},
    {-6500,0,-5500},
    {-5500,0,-5500},
    {-6500,0,-6500},
    {-5500,0,-6500},
    {-6500,0,-7500},
    {-5500,0,-7500},
    {-2750,0,-4250}
};

INDEX collider_vertex_indices[] = {
    {1,14,4,15},
    {31,33,28,32},
    {39,41,38,40},
    {58,61,56,60},
    {66,68,67,69},
    {93,96,94,97},
    {105,111,107,112},
    {109,113,104,110},
    {104,110,105,111},
    {140,144,141,145},
    {164,168,162,166},
    {162,166,163,167},
    {163,167,165,169},
    {1,0,3,2},
    {1,4,0,5},
    {5,39,0,38},
    {4,6,5,7},
    {8,10,9,11},
    {6,8,7,9},
    {23,88,22,90},
    {10,12,11,13},
    {21,16,25,17},
    {14,18,15,22},
    {18,19,22,23},
    {19,20,23,24},
    {20,21,24,25},
    {27,34,3,35},
    {2,26,3,27},
    {31,28,30,29},
    {20,31,21,30},
    {33,37,32,36},
    {39,43,38,42},
    {43,45,42,44},
    {47,49,46,48},
    {45,47,44,46},
    {52,50,53,51},
    {39,52,43,53},
    {51,54,53,55},
    {51,127,54,136},
    {57,59,56,58},
    {46,57,44,56},
    {65,63,64,62},
    {61,66,65,67},
    {61,65,60,64},
    {66,70,67,71},
    {70,72,71,73},
    {77,75,76,74},
    {71,77,67,76},
    {83,79,80,78},
    {36,82,32,81},
    {82,83,81,80},
    {87,84,86,85},
    {82,87,83,86},
    {75,85,74,84},
    {95,92,94,93},
    {90,88,91,89},
    {6,90,8,91},
    {88,95,89,94},
    {100,98,101,99},
    {96,100,97,101},
    {99,102,101,103},
    {12,104,13,105},
    {105,107,13,106},
    {12,108,104,109},
    {115,119,116,120},
    {117,121,114,118},
    {110,114,111,115},
    {113,117,110,114},
    {111,115,112,116},
    {118,122,119,123},
    {114,118,115,119},
    {121,125,118,122},
    {119,123,120,124},
    {122,128,123,129},
    {125,131,122,128},
    {123,129,124,130},
    {141,133,143,132},
    {137,134,139,135},
    {54,136,126,138},
    {136,137,138,139},
    {126,261,54,55},
    {120,140,116,142},
    {140,141,142,143},
    {132,135,143,134},
    {144,146,145,147},
    {146,148,147,149},
    {148,150,149,151},
    {153,159,157,161},
    {16,152,17,153},
    {153,157,17,156},
    {16,154,152,155},
    {155,160,152,158},
    {152,158,153,159},
    {159,163,161,165},
    {158,162,159,163},
    {160,164,158,162},
    {176,171,174,170},
    {100,173,98,172},
    {161,177,157,175},
    {177,176,175,174},
    {173,174,172,170},
    {171,179,170,178},
    {179,181,178,180},
    {181,183,180,182},
    {98,184,99,185},
    {184,186,185,187},
    {182,191,180,190},
    {188,189,186,187},
    {186,190,188,191},
    {184,192,186,190},
    {193,195,194,196},
    {182,193,191,194},
    {195,197,196,198},
    {210,202,209,201},
    {197,199,198,200},
    {204,206,203,205},
    {202,204,201,203},
    {129,128,205,203},
    {200,212,198,207},
    {212,211,207,208},
    {211,210,208,209},
    {196,214,194,213},
    {216,218,215,217},
    {214,216,213,215},
    {217,220,215,219},
    {225,221,228,222},
    {155,223,160,226},
    {223,224,226,227},
    {224,225,227,228},
    {230,225,232,224},
    {80,229,81,231},
    {229,230,231,232},
    {49,234,48,233},
    {233,236,48,235},
    {49,237,234,238},
    {233,243,236,245},
    {237,239,238,240},
    {239,241,240,242},
    {244,250,243,249},
    {243,249,245,251},
    {246,252,244,250},
    {238,246,234,244},
    {240,247,238,246},
    {242,248,240,247},
    {234,244,233,243},
    {248,254,247,253},
    {247,253,246,252},
    {135,255,139,256},
    {255,257,256,258},
    {242,258,248,260},
    {257,259,258,260}
};
#pragma endregion

int isOnMesh(SVECTOR* p1, SVECTOR* p2, SVECTOR* c1, SVECTOR* c2) {
    if((p1->vx - c1->vx < 0 || c1->vz - p1->vz < 0) || 
        (c2->vx - p2->vx < 0 || p2->vz - c2->vz < 0)) {
        return 0;
    }
    return 1;
}

int isPlayerOnMesh(VECTOR* playerPos) {
    int isOn = 0;
    for(int i = 0; i < collider_faces; i++) {
        
        // This is not consistent. We need to calculate this. Will do it in game setup. For now we do it every frame ¯\_(ツ)_/¯

        SVECTOR topLeft = collider_vertices[collider_vertex_indices[i].v0];
        SVECTOR bottomRight = collider_vertices[collider_vertex_indices[i].v0];
        if(collider_vertices[collider_vertex_indices[i].v0].vx <= topLeft.vx && collider_vertices[collider_vertex_indices[i].v0].vz >= topLeft.vz) {
            topLeft = collider_vertices[collider_vertex_indices[i].v0];
        }
        if(collider_vertices[collider_vertex_indices[i].v0].vx >= bottomRight.vx && collider_vertices[collider_vertex_indices[i].v0].vz <= bottomRight.vz) {
            bottomRight = collider_vertices[collider_vertex_indices[i].v0];
        }

        if(collider_vertices[collider_vertex_indices[i].v1].vx <= topLeft.vx && collider_vertices[collider_vertex_indices[i].v1].vz >= topLeft.vz) {
            topLeft = collider_vertices[collider_vertex_indices[i].v1];
        }
        if(collider_vertices[collider_vertex_indices[i].v1].vx >= bottomRight.vx && collider_vertices[collider_vertex_indices[i].v1].vz <= bottomRight.vz) {
            bottomRight = collider_vertices[collider_vertex_indices[i].v1];
        }

        if(collider_vertices[collider_vertex_indices[i].v2].vx <= topLeft.vx && collider_vertices[collider_vertex_indices[i].v2].vz >= topLeft.vz) {
            topLeft = collider_vertices[collider_vertex_indices[i].v2];
        }
        if(collider_vertices[collider_vertex_indices[i].v2].vx >= bottomRight.vx && collider_vertices[collider_vertex_indices[i].v2].vz <= bottomRight.vz) {
            bottomRight = collider_vertices[collider_vertex_indices[i].v2];
        }

        if(collider_vertices[collider_vertex_indices[i].v3].vx <= topLeft.vx && collider_vertices[collider_vertex_indices[i].v3].vz >= topLeft.vz) {
            topLeft = collider_vertices[collider_vertex_indices[i].v3];
        }
        if(collider_vertices[collider_vertex_indices[i].v3].vx >= bottomRight.vx && collider_vertices[collider_vertex_indices[i].v3].vz <= bottomRight.vz) {
            bottomRight = collider_vertices[collider_vertex_indices[i].v3];
        }

        SVECTOR face1 = topLeft;
        SVECTOR face2 = bottomRight;
        SVECTOR p1 = {playerPos->vx-PLAYER_SIZE, 0, playerPos->vz+PLAYER_SIZE};
        SVECTOR p2 = {playerPos->vx+PLAYER_SIZE, 0, playerPos->vz-PLAYER_SIZE};
        if(isOnMesh(&p1, &p2, &face1, &face2)) {
            isOn = 1;
        }
    }
    return isOn;
}